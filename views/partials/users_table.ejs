<link rel="stylesheet" type="text/css" href="/styles/tables.css">
<div id="users-container">
    <table class="users">
        <thead>
            <tr>
                <th>UID</th>
                <th>Username</th>
                <th>Role</th>
                <th><button id="new-user-button" class="new-user-button">Create User</button></th>
            </tr>
        </thead>
        <tbody>
            <% users.forEach(user => { %>
                <tr id="user-row-<%=user.userId%>">
                    <td><%= user.user_id %></td>
                    <td><%= user.username %></td>
                    <td><%= user.role %></td>
                    <td>
                        <input type="button" value="Delete" class="delete-button" onclick="deleteUser('<%= user.userId%>')" />
                        <input type="button" value="Edit" class="edit-button" onclick="editUser('<%= user.userId%>')">
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>    
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const newUserButton = document.getElementById('new-user-button');
        const usersContainer = document.getElementById('users-container');
        const formContainer = document.getElementById('user-form-container');
        const userForm = document.getElementById('user-form');

        newUserButton.addEventListener('click', function() {
            formContainer.style.display = 'block';
            usersContainer.style.display = 'none';
        });
        
        function editUser(userId) {
            const userRow = document.getElementById(`user-row-${userId}`);
            const uidInput = userForm.elements['userid'];
            const usernameInput = userForm.elements['username'];
            const roleInput = userForm.elements['role'];
            
            uidInput.value = userId;
            usernameInput.value = userRow.cells[1].textContent;
            roleInput.value = userRow.cells[2].textContent;;

            formContainer.style.display = 'block';
            usersContainer.style.display = 'none';;
        }
    });
        
    async function deleteUser(userId) {
        console.log('Deletion started');

        const confirmed = confirm(`Are you sure you want to delete user with ID: "${userId}"?`);
        
        if (!confirmed) {
            return;
        }

        try {
            const response = await fetch(`/app/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const deletedRow = document.getElementById(`user-row-${userId}`);
                if (deletedRow) {
                    deletedRow.remove();
                    console.log("User deleted successfully.");
                } else {
                    console.error("Error: Deleted row not found in the table.");
                }
            } else {
                const errorMessage = await response.text();
                console.error(`Error deleting user: ${errorMessage}`);
            }
        } catch (error) {
            console.error("Error:", error);
        }
    };
</script>